# OCI Code Server ARM

Deploy code-server (VS Code in the browser) on Oracle Cloud Infrastructure (OCI) ARM instances with K3s multi-node cluster.

## Overview

This project provides Infrastructure as Code (IaC) to deploy:
- OCI ARM instances (VM.Standard.A1.Flex) using Always Free tier
- K3s multi-node Kubernetes cluster
- Code-server deployment with persistent storage
- Nginx Ingress Controller for external access

## Prerequisites

- OCI account with configured CLI/API access
- Terraform installed
- SSH key pair available
- OCI config file at `~/.oci/config`

## Quick Start

1. **Deploy Infrastructure:**
   ```bash
   ./deploy.sh
   ```

2. **Get kubeconfig:**
   ```bash
   # Copy kubeconfig from master node (replace with your username)
   scp $USER@<master-ip>:~/.kube/config ~/.kube/config-oci
   export KUBECONFIG=~/.kube/config-oci
   ```

3. **Deploy Code-Server:**
   ```bash
   ./deploy-code-server.sh
   ```

4. **Access Code-Server:**
   ```bash
   # Port forward to access locally
   kubectl port-forward -n code-server svc/code-server-service 8080:8080
   ```
   Then visit: http://localhost:8080 (password: set in values.yaml)

## Architecture

### Infrastructure
- **Network**: VCN with public subnet and internet gateway
- **Compute**: ARM instances (1 master, 2 workers by default)
- **Storage**: Block storage with persistent volumes
- **Security**: Security lists with K3s required ports

### Kubernetes
- **K3s**: Lightweight Kubernetes distribution
- **Ingress**: Nginx Ingress Controller
- **Storage**: Local persistent volumes
- **Networking**: Flannel CNI with VXLAN

### Code-Server
- **Container**: Official code-server image
- **Deployment**: Helm chart for easy configuration
- **Storage**: Persistent workspace data
- **Access**: Password-based authentication
- **Features**: Full VS Code experience in browser

## Configuration

### Infrastructure Configuration
Edit `terraform/terraform.tfvars` (auto-generated by `deploy.sh`):
```hcl
# Instance configuration
instance_shape           = "VM.Standard.A1.Flex"
instance_ocpus          = 2
instance_memory_in_gbs  = 12
boot_volume_size_in_gbs = 50

# K3s cluster configuration
master_nodes = 1
worker_nodes = 2
```

### Code-Server Configuration
Edit `helm-chart/code-server/values.yaml`:
```yaml
codeServer:
  password: "YOUR-SECURE-PASSWORD-HERE"  # CHANGE THIS!
  config:
    bind-addr: "0.0.0.0:8080"
    auth: "password"
    # ... other settings
```

### Security Configuration
Change default password using Helm:
```bash
# During deployment
helm install code-server ./helm-chart/code-server -n code-server --set codeServer.password=your-new-password

# Or upgrade existing deployment
helm upgrade code-server ./helm-chart/code-server -n code-server --set codeServer.password=your-new-password
```

## Management Commands

### Infrastructure Management
```bash
# Deploy infrastructure
./deploy.sh

# Show outputs
./deploy.sh output

# Destroy infrastructure
./deploy.sh destroy
```

### Code-Server Management
```bash
# Deploy code-server
./deploy-code-server.sh

# Show deployment status
./deploy-code-server.sh status

# Show access information
./deploy-code-server.sh access

# View logs
./deploy-code-server.sh logs

# Upgrade deployment
./deploy-code-server.sh upgrade

# Show current Helm values
./deploy-code-server.sh values

# Delete deployment
./deploy-code-server.sh delete
```

### Direct Helm and K3s Commands
```bash
# Check cluster status
kubectl get nodes
kubectl get pods --all-namespaces

# Helm operations
helm list -n code-server
helm status code-server -n code-server
helm get values code-server -n code-server

# Access code-server pod  
kubectl exec -it -n code-server deployment/code-server -- /bin/bash

# Check ingress
kubectl get ingress -n code-server
```

## Troubleshooting

### Common Issues

1. **K3s nodes not joining:**
   - Check security group rules
   - Verify master node is fully started
   - Check cloud-init logs: `sudo journalctl -u cloud-final`

2. **Code-server not accessible:**
   - Check pod status: `kubectl get pods -n code-server`
   - Check service: `kubectl get svc -n code-server`
   - Use port-forward for direct access

3. **Storage issues:**
   - Verify PV directory exists: `/opt/code-server-data`
   - Check PV/PVC status: `kubectl get pv,pvc -n code-server`

### Log Locations
- **Cloud-init**: `/var/log/cloud-init-output.log`
- **K3s**: `journalctl -u k3s`
- **Code-server**: `kubectl logs -n code-server deployment/code-server`

## Cost Optimization

- Uses OCI Always Free tier ARM instances
- Configurable instance shapes and storage
- Automatic resource tagging for cost tracking
- Efficient resource utilization with K3s

## Security Considerations

- SSH key-based authentication
- Security groups with minimal required ports
- Private cluster communication
- Regular security updates via cloud-init

## Customization

### Adding Applications
Deploy additional applications to the K3s cluster:
```bash
# Example: Deploy monitoring stack
kubectl apply -f monitoring-manifests/
```

### Custom Domains
Update ingress configuration in `helm-chart/code-server/values.yaml`:
```yaml
ingress:
  enabled: true
  hosts:
    - host: code.yourdomain.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: code-server-tls
      hosts:
        - code.yourdomain.com
```

## Contributing

1. Fork the repository
2. Create feature branch
3. Test changes thoroughly
4. Submit pull request

## License

This project is open source. See LICENSE file for details.