# OCI ARM Development Environment

Complete cloud-native development environment on Oracle Cloud Infrastructure ARM instances with K3d HA cluster, code-server (VS Code in browser), deployed using **Terraform/OpenTofu** and **Ansible**.

## 🚀 Quick Start

```bash
# Deploy with Terraform
./deploy.sh deploy

# Deploy with OpenTofu
TOFU=true ./deploy.sh deploy

# Deploy code-server
./deploy-code-server.sh

# Access your environment
kubectl port-forward -n code-server svc/code-server-service 8080:8080
# Visit: http://localhost:8080
```

## ✨ Features

- **Infrastructure as Code**: Choose Terraform or OpenTofu
- **K3d HA Cluster**: 3 masters + 3 workers in Docker containers
- **Always Free Tier**: Maximum OCI ARM resources (4 vCPUs, 24GB RAM)
- **Code-Server**: Full VS Code experience in browser
- **Ansible Configuration**: Idempotent system configuration
- **Helm Charts**: Easy application deployment
- **High Availability**: Production-like HA patterns

## 📋 Prerequisites

- **OCI Account** with Always Free tier
- **Local Tools**:
  - Terraform (>= 1.0) **OR** OpenTofu (>= 1.0)
  - Ansible (>= 2.9)
  - kubectl
  - SSH key pair in `~/.ssh/`
- **OCI Configuration**: `~/.oci/config` with API credentials

### Install Prerequisites (macOS)

```bash
# Choose Terraform or OpenTofu
brew install terraform
# OR
brew install opentofu

# Install Ansible and kubectl
brew install ansible kubectl
```

## 🏗️ Architecture

```
OCI ARM Instance (VM.Standard.A1.Flex: 4 vCPUs, 24GB RAM)
├── Docker Engine
│   └── K3d HA Cluster
│       ├── Masters (3 nodes - etcd quorum)
│       └── Workers (3 nodes - load distribution)
├── Code-Server (VS Code in browser)
├── Nginx Ingress Controller
└── Persistent Storage (Docker volumes)
```

### Key Components

- **Single VM**: Maximum Always Free tier resources
- **K3d Cluster**: Containerized Kubernetes with HA
- **Terraform/OpenTofu**: Infrastructure provisioning
- **Ansible**: Configuration management
- **Helm**: Application deployment

## 📥 Installation

### 1. Clone Repository

```bash
git clone https://github.com/idvoretskyi/oci-arm-dev-env.git
cd oci-arm-dev-env
```

### 2. Configure OCI

Ensure `~/.oci/config` is configured:

```ini
[DEFAULT]
user=ocid1.user.oc1..xxx
fingerprint=xx:xx:xx:xx
tenancy=ocid1.tenancy.oc1..xxx
region=uk-london-1
key_file=/Users/yourname/.oci/oci_api_key.pem
```

### 3. Deploy Infrastructure

**Using Terraform:**
```bash
./deploy.sh deploy
```

**Using OpenTofu:**
```bash
TOFU=true ./deploy.sh deploy
```

This will:
1. Provision OCI infrastructure (VCN, subnet, compute)
2. Configure system with Ansible (Docker, K3s, dev tools)
3. Set up K3d HA cluster (3 masters + 3 workers)
4. Install kubectl, Helm, and development stack

### 4. Deploy Code-Server

```bash
./deploy-code-server.sh
```

### 5. Access Environment

```bash
# Port forward to local machine
kubectl port-forward -n code-server svc/code-server-service 8080:8080

# Open browser
open http://localhost:8080
```

**Password**: Check `helm-chart/code-server/values.yaml` (CHANGE THIS!)

## ⚙️ Configuration

### Infrastructure (terraform/terraform.tfvars)

Auto-generated by deploy script, or customize:

```hcl
# Instance (Always Free maximum)
instance_shape           = "VM.Standard.A1.Flex"
instance_ocpus          = 4     # Max for Always Free
instance_memory_in_gbs  = 24    # Max for Always Free

# K3d HA cluster
k3d_nodes    = 6     # Total nodes
k3d_masters  = 3     # HA masters (odd number)
k3d_workers  = 3     # HA workers

# Storage
boot_volume_size_in_gbs = 50
```

### Application (helm-chart/code-server/values.yaml)

```yaml
codeServer:
  password: "CHANGE-THIS-PASSWORD"
  resources:
    limits:
      cpu: "2000m"
      memory: "4Gi"
    requests:
      cpu: "500m"
      memory: "1Gi"
```

## 🎯 Usage

### Infrastructure Management

```bash
# Deploy (Terraform)
./deploy.sh deploy

# Deploy (OpenTofu)
TOFU=true ./deploy.sh deploy

# Configure only (no infrastructure changes)
./deploy.sh configure

# Show outputs
./deploy.sh output

# Destroy
./deploy.sh destroy
```

### K3d Cluster Management

SSH to instance first, then:

```bash
# Cluster operations
k3d cluster list
k3d cluster info k3s-ha-cluster
k3d node list

# Check HA health
kubectl get nodes -o wide              # 6 nodes (3 masters + 3 workers)
kubectl get pods -n kube-system
kubectl cluster-info
kubectl get endpoints kubernetes -n default  # 3 master IPs

# Scale cluster
k3d node create new-worker --cluster k3s-ha-cluster --role agent
```

### Code-Server Management

```bash
# Deploy/upgrade
./deploy-code-server.sh
./deploy-code-server.sh upgrade

# Status and logs
./deploy-code-server.sh status
./deploy-code-server.sh logs

# Change password
helm upgrade code-server ./helm-chart/code-server -n code-server \
  --set codeServer.password=new-password

# Delete
./deploy-code-server.sh delete
```

## 🔧 Troubleshooting

### K3d Cluster Issues

```bash
# Check Docker
sudo systemctl status docker

# Check cloud-init logs
sudo cat /var/log/cloud-init-output.log

# Verify K3d installation
k3d version
k3d cluster list

# Check all nodes
kubectl get nodes -o wide

# Check master endpoints (should show 3 IPs)
kubectl get endpoints kubernetes -n default

# Check system pods
kubectl get pods -n kube-system
```

### Code-Server Issues

```bash
# Check pod status
kubectl get pods -n code-server
kubectl logs -n code-server deployment/code-server

# Direct port-forward (bypass ingress)
kubectl port-forward -n code-server pod/<pod-name> 8080:8080
```

### Infrastructure Issues

```bash
# Validate configuration
cd terraform/
terraform validate  # or: tofu validate

# Check state
terraform show      # or: tofu show
```

## 💰 Cost Optimization

- **Always Free Tier**: Uses maximum free ARM resources
- **Single VM**: No additional VMs needed for HA
- **Container Efficiency**: K3d nodes share host kernel
- **Resource Utilization**: 24GB RAM across 6 containerized nodes

## 🔒 Security

- **SSH Authentication**: Key-based only
- **Security Lists**: Minimal required ports (22, 6443, 80, 443, 8080)
- **Firewall**: UFW configured automatically
- **Kubernetes RBAC**: Role-based access control
- **Password Protection**: Code-server authentication

### Change Default Password

```bash
helm upgrade code-server ./helm-chart/code-server -n code-server \
  --set codeServer.password=your-strong-password
```

## 📚 Documentation

- **CLAUDE.md**: Detailed architecture and implementation
- **ARCHITECTURE.md**: System design and patterns
- **SECURITY.md**: Security considerations
- **terraform/**: Infrastructure as Code
- **ansible/**: Configuration management
- **helm-chart/**: Application deployment

## 🎓 Benefits of K3d HA

- **Master HA**: Survives 1 master failure (etcd quorum)
- **Worker HA**: Load distribution across 3 workers
- **Production-Like**: Real Kubernetes HA patterns
- **Cost-Effective**: Single VM with container-based HA
- **Fast Deployment**: Containers start in seconds
- **Easy Scaling**: Add/remove nodes without VM provisioning

## 🤝 Contributing

Contributions welcome! Please:

1. Fork the repository
2. Create a feature branch
3. Test with both Terraform and OpenTofu
4. Submit a pull request

## 📄 License

MIT License - See [LICENSE](LICENSE) file for details.

---

**Questions?** Check [CLAUDE.md](CLAUDE.md) for detailed implementation guide.
